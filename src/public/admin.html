<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administraci√≥n - Vive+Salud</title>
  <style>
    :root {
      --primary: #2b6777;
      --primary-dark: #1f4a56;
      --accent: #52ab98;
      --accent-soft: rgba(82, 171, 152, 0.12);
      --danger: #e74c3c;
      --bg: #f3f6fb;
      --card-bg: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7380;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at top left, rgba(82,171,152,0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(43,103,119,0.16), transparent 55%),
        var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 26px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.5);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .brand-icon {
      width: 34px;
      height: 34px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 20%, #ffffff, #ffd6c2);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.22);
      font-size: 18px;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.5px;
    }

    header .admin-info {
      font-size: 13px;
      text-align: right;
    }

    header .admin-info strong {
      font-weight: 600;
    }

    header .logout-btn {
      margin-top: 4px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.5);
      background: rgba(0,0,0,0.12);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    header .logout-btn:hover {
      background: rgba(0,0,0,0.25);
    }

    /* LAYOUT */

    .layout {
      display: flex;
      flex: 1;
      max-width: 1200px;
      width: 95%;
      margin: 18px auto 26px;
      gap: 18px;
    }

    /* SIDEBAR */

    .sidebar {
      width: 220px;
      background: rgba(255,255,255,0.94);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 18px 14px;
      border: 1px solid rgba(148,163,184,0.25);
      backdrop-filter: blur(6px);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin: 0 0 8px;
    }

    .nav-btn {
      width: 100%;
      border: none;
      padding: 9px 12px;
      border-radius: 999px;
      text-align: left;
      background: transparent;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      transition: 0.2s ease;
    }

    .nav-btn span.icon {
      width: 22px;
      display: inline-flex;
      justify-content: center;
    }

    .nav-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 8px 18px rgba(15,23,42,0.35);
    }

    .nav-btn:not(.active):hover {
      background: rgba(82,171,152,0.09);
      color: var(--primary-dark);
    }

    /* MAIN CONTENT */

    .main {
      flex: 1;
      background: rgba(255,255,255,0.98);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 20px 20px 22px;
      border: 1px solid rgba(148,163,184,0.25);
      backdrop-filter: blur(6px);
      overflow: hidden;
    }

    .main h2 {
      margin: 0 0 8px;
      font-size: 20px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .main h2::after {
      content: "";
      flex: 1;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), transparent);
    }

    .main .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .panel {
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    .panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* TABLES */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }

    thead {
      background: #f9fafb;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tr:hover td {
      background: #f8fafc;
    }

    /* FORMS */

    .form-card {
      margin-top: 14px;
      padding: 12px 14px;
      background: #f9fafb;
      border-radius: var(--radius-md);
      border: 1px solid #e5e7eb;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px 14px;
      align-items: end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 10px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: 0.18s;
    }

    .form-group textarea {
      border-radius: 10px;
      resize: vertical;
      min-height: 50px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn-primary {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(15,23,42,0.3);
      transition: 0.18s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15,23,42,0.35);
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 7px 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-main);
      transition: 0.15s;
    }

    .btn-secondary:hover {
      background: #f3f4f6;
    }

    .btn-danger {
      border-radius: 999px;
      padding: 6px 10px;
      border: none;
      background: var(--danger);
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      transition: 0.15s;
    }

    .btn-danger:hover {
      filter: brightness(0.95);
    }

    .tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(82,171,152,0.12);
      color: var(--primary-dark);
      font-size: 11px;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-pendiente {
      background: #fff4e5;
      color: #b96b22;
    }
    .status-pagado {
      background: #e5f9ed;
      color: #1b8a4b;
    }
    .status-cancelado {
      background: #fde2e0;
      color: #c0392b;
    }

    /* PANEL DETALLE DE PEDIDO */

    .detalle-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      backdrop-filter: blur(3px);
    }

    .detalle-overlay.open {
      display: flex;
    }

    .detalle-card {
      width: min(560px, 94%);
      max-height: 80vh;
      background: #ffffff;
      border-radius: var(--radius-lg);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.55);
      padding: 18px 20px 16px;
      display: flex;
      flex-direction: column;
    }

    .detalle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .detalle-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--primary-dark);
    }

    .detalle-close {
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      color: #6b7280;
    }

    .detalle-body {
      font-size: 13px;
      color: var(--text-main);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .detalle-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 6px 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .detalle-info label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .detalle-info span {
      font-weight: 500;
    }

    .detalle-lineas {
      margin-top: 4px;
      flex: 1;
      overflow: auto;
    }

    .detalle-lineas table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .detalle-lineas th,
    .detalle-lineas td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    .detalle-lineas thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .detalle-total-footer {
      margin-top: 6px;
      text-align: right;
      font-weight: 600;
      color: var(--primary-dark);
      font-size: 13px;
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .nav-btn {
        flex: 1 1 calc(50% - 6px);
      }
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .admin-info {
        text-align: left;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-icon">üíö</div>
    <div>
      <h1>Panel de Administraci√≥n</h1>
      <div style="font-size: 12px; opacity: 0.9;">Vive+Salud</div>
    </div>
  </div>
  <div class="admin-info">
    <div id="adminNombre">Admin</div>
    <button class="logout-btn" onclick="window.location.href='/logout'">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <h2>Cat√°logos</h2>
    <button class="nav-btn active" id="btnTabProductos">
      <span class="icon">üì¶</span> Productos
    </button>
    <button class="nav-btn" id="btnTabCategorias">
      <span class="icon">üìÅ</span> Categor√≠as
    </button>
    <button class="nav-btn" id="btnTabClientes">
      <span class="icon">üë§</span> Clientes
    </button>
    <button class="nav-btn" id="btnTabPedidos">
      <span class="icon">üßæ</span> Pedidos
    </button>
  </aside>

  <main class="main">
    <!-- PANEL PRODUCTOS -->
    <section id="panelProductos" class="panel active">
      <h2>Productos</h2>
      <p class="subtitle">
        Administra los productos que se muestran en la tienda Vive+Salud.
      </p>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Modelo</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Categor√≠a</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyProductos"></tbody>
      </table>

      <div class="form-card">
        <div class="form-group">
          <label for="prodId">ID (solo edici√≥n)</label>
          <input type="text" id="prodId" readonly placeholder="Nuevo producto" />
        </div>
        <div class="form-group">
          <label for="prodNombre">Nombre</label>
          <input type="text" id="prodNombre" placeholder="Ej. Membres√≠a Premium" />
        </div>
        <div class="form-group">
          <label for="prodModelo">Modelo</label>
          <input type="text" id="prodModelo" placeholder="Ej. PREM001" />
        </div>
        <div class="form-group">
          <label for="prodPrecio">Precio</label>
          <input type="number" id="prodPrecio" step="0.01" min="0" />
        </div>
        <div class="form-group">
          <label for="prodCantidad">Stock</label>
          <input type="number" id="prodCantidad" min="0" />
        </div>
        <div class="form-group">
          <label for="prodCategoria">Categor√≠a</label>
          <select id="prodCategoria"></select>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn-primary" id="btnGuardarProducto">Guardar producto</button>
        </div>
      </div>
    </section>

    <!-- PANEL CATEGOR√çAS -->
    <section id="panelCategorias" class="panel">
      <h2>Categor√≠as</h2>
      <p class="subtitle">
        Crea y organiza las categor√≠as para agrupar tus productos.
      </p>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyCategorias"></tbody>
      </table>

      <div class="form-card">
        <div class="form-group">
          <label for="catId">ID (solo edici√≥n)</label>
          <input type="text" id="catId" readonly placeholder="Nueva categor√≠a" />
        </div>
        <div class="form-group">
          <label for="catNombre">Nombre</label>
          <input type="text" id="catNombre" placeholder="Ej. Bienestar digital" />
        </div>
        <div class="form-group">
          <label for="catDescripcion">Descripci√≥n</label>
          <textarea id="catDescripcion" placeholder="Describe la categor√≠a"></textarea>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn-primary" id="btnGuardarCategoria">Guardar categor√≠a</button>
        </div>
      </div>
    </section>

    <!-- PANEL CLIENTES -->
    <section id="panelClientes" class="panel">
      <h2>Clientes</h2>
      <p class="subtitle">
        Consulta y actualiza la informaci√≥n de los usuarios registrados.
      </p>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre completo</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyClientes"></tbody>
      </table>

      <div class="form-card">
        <div class="form-group">
          <label for="cliId">ID (solo edici√≥n)</label>
          <input type="text" id="cliId" readonly placeholder="Selecciona un cliente" />
        </div>
        <div class="form-group">
          <label for="cliNombre">Nombre completo</label>
          <input type="text" id="cliNombre" />
        </div>
        <div class="form-group">
          <label for="cliEmail">Email</label>
          <input type="email" id="cliEmail" />
        </div>
        <div class="form-group">
          <label for="cliTelefono">Tel√©fono</label>
          <input type="text" id="cliTelefono" />
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn-primary" id="btnGuardarCliente">Guardar cambios</button>
        </div>
      </div>
    </section>

    <!-- PANEL PEDIDOS -->
    <section id="panelPedidos" class="panel">
      <h2>Pedidos</h2>
      <p class="subtitle">
        Revisa los pedidos realizados por los clientes en la plataforma.
      </p>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Email</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody id="tablaPedidosBody"></tbody>
      </table>
    </section>
  </main>
</div>

<!-- PANEL DETALLE DE PEDIDO -->
<div id="detalleOverlay" class="detalle-overlay">
  <div class="detalle-card">
    <div class="detalle-header">
      <h3>Detalle del pedido #<span id="detalleId"></span></h3>
      <button id="detalleCerrar" class="detalle-close">&times;</button>
    </div>
    <div class="detalle-body">
      <div class="detalle-info">
        <div>
          <label>Cliente</label>
          <span id="detalleCliente">-</span>
        </div>
        <div>
          <label>Email</label>
          <span id="detalleEmail">-</span>
        </div>
        <div>
          <label>Tel√©fono</label>
          <span id="detalleTelefono">-</span>
        </div>
        <div>
          <label>Fecha</label>
          <span id="detalleFecha">-</span>
        </div>
        <div>
          <label>Estado</label>
          <span id="detalleEstado">-</span>
        </div>
        <div>
          <label>Total</label>
          <span id="detalleTotal">-</span>
        </div>
      </div>

      <div class="detalle-lineas">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="detalleLineasBody"></tbody>
        </table>
      </div>

      <div class="detalle-total-footer" id="detalleTotalFooter"></div>
    </div>
  </div>
</div>

<script>
  // ======================
  // INFO ADMIN (desde sessionStorage)
  // ======================
  (function initAdminName() {
    const span = document.getElementById("adminNombre");
    try {
      const usuario = JSON.parse(sessionStorage.getItem("usuario") || "null");
      if (usuario && usuario.nombre_completo) {
        span.textContent = usuario.nombre_completo;
      } else {
        span.textContent = "Administrador";
      }
    } catch {
      span.textContent = "Administrador";
    }
  })();

  // ======================
  // NAVEGACI√ìN ENTRE PANELES
  // ======================
  const btnTabProductos = document.getElementById("btnTabProductos");
  const btnTabCategorias = document.getElementById("btnTabCategorias");
  const btnTabClientes   = document.getElementById("btnTabClientes");
  const btnTabPedidos    = document.getElementById("btnTabPedidos");

  const panelProductos  = document.getElementById("panelProductos");
  const panelCategorias = document.getElementById("panelCategorias");
  const panelClientes   = document.getElementById("panelClientes");
  const panelPedidos    = document.getElementById("panelPedidos");

  function activarTab(btnActivo, panelActivo) {
    [btnTabProductos, btnTabCategorias, btnTabClientes, btnTabPedidos].forEach(b => b.classList.remove("active"));
    [panelProductos, panelCategorias, panelClientes, panelPedidos].forEach(p => p.classList.remove("active"));

    btnActivo.classList.add("active");
    panelActivo.classList.add("active");
  }

  btnTabProductos.addEventListener("click", () => {
    activarTab(btnTabProductos, panelProductos);
    cargarProductos();
  });

  btnTabCategorias.addEventListener("click", () => {
    activarTab(btnTabCategorias, panelCategorias);
    cargarCategorias();
  });

  btnTabClientes.addEventListener("click", () => {
    activarTab(btnTabClientes, panelClientes);
    cargarClientes();
  });

  btnTabPedidos.addEventListener("click", () => {
    activarTab(btnTabPedidos, panelPedidos);
    cargarPedidos();
  });

  // ======================
  // CATEGOR√çAS (para panel + select de productos)
  // ======================
  const tbodyCategorias = document.getElementById("tbodyCategorias");
  const catId           = document.getElementById("catId");
  const catNombre       = document.getElementById("catNombre");
  const catDescripcion  = document.getElementById("catDescripcion");
  const btnGuardarCategoria = document.getElementById("btnGuardarCategoria");

  const prodCategoriaSelect = document.getElementById("prodCategoria");

  async function cargarCategorias(paraSelectTambi√©n = true) {
    try {
      const res = await fetch("/admin/categorias");
      if (!res.ok) throw new Error("Error al cargar categor√≠as");
      const categorias = await res.json();

      // Tabla en panel Categor√≠as
      if (tbodyCategorias) {
        tbodyCategorias.innerHTML = "";
        categorias.forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.name || ""}</td>
            <td>${c.description || ""}</td>
            <td>
              <button class="btn-secondary" data-id="${c.id}">Editar</button>
              <button class="btn-danger" data-del="${c.id}">Eliminar</button>
            </td>
          `;
          tbodyCategorias.appendChild(tr);
        });

        // Eventos editar / eliminar
        tbodyCategorias.querySelectorAll("button.btn-secondary").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const cat = categorias.find(c => String(c.id) === String(id));
            if (!cat) return;
            catId.value = cat.id;
            catNombre.value = cat.name || "";
            catDescripcion.value = cat.description || "";
          });
        });

        tbodyCategorias.querySelectorAll("button.btn-danger").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.del;
            if (!confirm("¬øEliminar esta categor√≠a?")) return;
            await fetch("/admin/categorias/" + id, { method: "DELETE" });
            cargarCategorias();
            cargarCategoriasSelect();
          });
        });
      }

      // Para select de Productos
      if (paraSelectTambi√©n) {
        cargarCategoriasSelect(categorias);
      }

    } catch (err) {
      console.error(err);
    }
  }

  function cargarCategoriasSelect(lista) {
    if (!prodCategoriaSelect) return;
    if (!lista) {
      // recarga desde API
      fetch("/admin/categorias")
        .then(r => r.json())
        .then(cats => cargarCategoriasSelect(cats))
        .catch(console.error);
      return;
    }
    prodCategoriaSelect.innerHTML = "";
    lista.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name || ("Categor√≠a " + c.id);
      prodCategoriaSelect.appendChild(opt);
    });
  }

  btnGuardarCategoria.addEventListener("click", async () => {
    const id   = catId.value.trim();
    const name = catNombre.value.trim();
    const description = catDescripcion.value.trim();

    if (!name) {
      alert("El nombre de la categor√≠a es obligatorio");
      return;
    }

    try {
      if (id) {
        // actualizar
        await fetch("/admin/categorias/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description })
        });
      } else {
        // crear
        await fetch("/admin/categorias", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description })
        });
      }
      catId.value = "";
      catNombre.value = "";
      catDescripcion.value = "";
      cargarCategorias();
      cargarCategoriasSelect();
    } catch (err) {
      console.error(err);
      alert("Error al guardar categor√≠a");
    }
  });

  // ======================
  // PRODUCTOS
  // ======================
  const tbodyProductos = document.getElementById("tbodyProductos");
  const prodId         = document.getElementById("prodId");
  const prodNombre     = document.getElementById("prodNombre");
  const prodModelo     = document.getElementById("prodModelo");
  const prodPrecio     = document.getElementById("prodPrecio");
  const prodCantidad   = document.getElementById("prodCantidad");
  const btnGuardarProducto = document.getElementById("btnGuardarProducto");

  async function cargarProductos() {
    try {
      const res = await fetch("/admin/productos");
      if (!res.ok) throw new Error("Error al obtener productos");
      const productos = await res.json();

      tbodyProductos.innerHTML = "";

      productos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name || ""}</td>
          <td>${p.model}</td>
          <td>$${Number(p.price).toFixed(2)}</td>
          <td>${p.quantity}</td>
          <td>${p.categoria_nombre ? `<span class="tag">${p.categoria_nombre}</span>` : ""}</td>
          <td>
            <button class="btn-secondary" data-id="${p.id}">Editar</button>
            <button class="btn-danger" data-del="${p.id}">Eliminar</button>
          </td>
        `;
        tbodyProductos.appendChild(tr);
      });

      // eventos de editar
      tbodyProductos.querySelectorAll("button.btn-secondary").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const prod = productos.find(p => String(p.id) === String(id));
          if (!prod) return;
          prodId.value       = prod.id;
          prodNombre.value   = prod.name || "";
          prodModelo.value   = prod.model || "";
          prodPrecio.value   = prod.price;
          prodCantidad.value = prod.quantity;
          if (prod.categoria_id && prodCategoriaSelect) {
            prodCategoriaSelect.value = prod.categoria_id;
          }
        });
      });

      // eventos de eliminar
      tbodyProductos.querySelectorAll("button.btn-danger").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.del;
          if (!confirm("¬øEliminar este producto?")) return;
          await fetch("/admin/productos/" + id, { method: "DELETE" });
          cargarProductos();
        });
      });

    } catch (err) {
      console.error(err);
    }
  }

  btnGuardarProducto.addEventListener("click", async () => {
    const id        = prodId.value.trim();
    const name      = prodNombre.value.trim();
    const model     = prodModelo.value.trim();
    const price     = parseFloat(prodPrecio.value || "0");
    const quantity  = parseInt(prodCantidad.value || "0", 10);
    const category_id = prodCategoriaSelect.value;

    if (!name || !model) {
      alert("Nombre y modelo son obligatorios");
      return;
    }

    const body = { name, model, price, quantity, category_id };

    try {
      if (id) {
        // update
        await fetch("/admin/productos/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      } else {
        // create
        await fetch("/admin/productos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      }

      prodId.value = "";
      prodNombre.value = "";
      prodModelo.value = "";
      prodPrecio.value = "";
      prodCantidad.value = "";

      cargarProductos();
    } catch (err) {
      console.error(err);
      alert("Error al guardar producto");
    }
  });

  // ======================
  // CLIENTES
  // ======================
  const tbodyClientes = document.getElementById("tbodyClientes");
  const cliId         = document.getElementById("cliId");
  const cliNombre     = document.getElementById("cliNombre");
  const cliEmail      = document.getElementById("cliEmail");
  const cliTelefono   = document.getElementById("cliTelefono");
  const btnGuardarCliente = document.getElementById("btnGuardarCliente");

  async function cargarClientes() {
    try {
      const res = await fetch("/admin/clientes");
      if (!res.ok) throw new Error("Error al obtener clientes");
      const clientes = await res.json();

      tbodyClientes.innerHTML = "";

      clientes.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.id}</td>
          <td>${c.nombre_completo}</td>
          <td>${c.email}</td>
          <td>${c.telefono || ""}</td>
          <td>
            <button class="btn-secondary" data-id="${c.id}">Editar</button>
            <button class="btn-danger" data-del="${c.id}">Eliminar</button>
          </td>
        `;
        tbodyClientes.appendChild(tr);
      });

      tbodyClientes.querySelectorAll("button.btn-secondary").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const cli = clientes.find(c => String(c.id) === String(id));
          if (!cli) return;
          cliId.value       = cli.id;
          cliNombre.value   = cli.nombre_completo || "";
          cliEmail.value    = cli.email || "";
          cliTelefono.value = cli.telefono || "";
        });
      });

      tbodyClientes.querySelectorAll("button.btn-danger").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.del;
          if (!confirm("¬øEliminar este cliente?")) return;
          await fetch("/admin/clientes/" + id, { method: "DELETE" });
          cargarClientes();
        });
      });

    } catch (err) {
      console.error(err);
    }
  }

  btnGuardarCliente.addEventListener("click", async () => {
    const id              = cliId.value.trim();
    const nombre_completo = cliNombre.value.trim();
    const email           = cliEmail.value.trim();
    const telefono        = cliTelefono.value.trim();

    if (!id) {
      alert("Selecciona un cliente de la tabla para editarlo.");
      return;
    }
    if (!nombre_completo || !email) {
      alert("Nombre y email son obligatorios.");
      return;
    }

    try {
      await fetch("/admin/clientes/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre_completo, email, telefono })
      });
      cargarClientes();
    } catch (err) {
      console.error(err);
      alert("Error al guardar cliente");
    }
  });

  // ======================
  // REFERENCIAS PANEL DETALLE
  // ======================
  const detalleOverlay      = document.getElementById("detalleOverlay");
  const detalleCerrar       = document.getElementById("detalleCerrar");
  const detalleIdSpan       = document.getElementById("detalleId");
  const detalleClienteSpan  = document.getElementById("detalleCliente");
  const detalleEmailSpan    = document.getElementById("detalleEmail");
  const detalleTelefonoSpan = document.getElementById("detalleTelefono");
  const detalleFechaSpan    = document.getElementById("detalleFecha");
  const detalleEstadoSpan   = document.getElementById("detalleEstado");
  const detalleTotalSpan    = document.getElementById("detalleTotal");
  const detalleLineasBody   = document.getElementById("detalleLineasBody");
  const detalleTotalFooter  = document.getElementById("detalleTotalFooter");

  function abrirDetalleOverlay() {
    detalleOverlay.classList.add("open");
  }

  function cerrarDetalleOverlay() {
    detalleOverlay.classList.remove("open");
  }

  detalleCerrar.addEventListener("click", cerrarDetalleOverlay);
  detalleOverlay.addEventListener("click", (e) => {
    if (e.target === detalleOverlay) cerrarDetalleOverlay();
  });

  // ======================
  // PEDIDOS
  // ======================
  async function cargarPedidos() {
    try {
      const res = await fetch("/admin/api/pedidos");
      if (!res.ok) throw new Error("No se pudieron obtener los pedidos");
      const pedidos = await res.json();

      const tabla = document.getElementById("tablaPedidosBody");
      tabla.innerHTML = "";

      if (!pedidos.length) {
        tabla.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center; padding:12px; color:#6b7380;">
              No hay pedidos registrados todav√≠a.
            </td>
          </tr>
        `;
        return;
      }

      pedidos.forEach(p => {
        const tr = document.createElement("tr");
        const fechaStr = p.fecha ? new Date(p.fecha).toLocaleString() : "";
        const totalStr = "$" + Number(p.total).toFixed(2);
        const estadoClass =
          p.estado === "pagado"
            ? "status-pagado"
            : p.estado === "cancelado"
            ? "status-cancelado"
            : "status-pendiente";

        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.cliente}</td>
          <td>${p.email}</td>
          <td>${fechaStr}</td>
          <td>${totalStr}</td>
          <td>
            <span class="status-badge ${estadoClass}">${p.estado}</span><br/>
            <select class="estado-select" data-id="${p.id}" style="margin-top:4px; font-size:11px;">
              <option value="pendiente" ${p.estado === "pendiente" ? "selected" : ""}>pendiente</option>
              <option value="pagado" ${p.estado === "pagado" ? "selected" : ""}>pagado</option>
              <option value="cancelado" ${p.estado === "cancelado" ? "selected" : ""}>cancelado</option>
            </select>
          </td>
          <td>
            <button
              class="btn-secondary btn-ver-detalle"
              data-id="${p.id}">
              Ver detalle
            </button>
          </td>
        `;
        tabla.appendChild(tr);
      });

      // ver detalle
      document.querySelectorAll(".btn-ver-detalle").forEach(btn => {
        btn.addEventListener("click", () => {
          const idPedido = btn.dataset.id;
          const pedidoInfo = pedidos.find(p => String(p.id) === String(idPedido));
          cargarDetallePedido(idPedido, pedidoInfo || null);
        });
      });

      // cambiar estado
      document.querySelectorAll(".estado-select").forEach(sel => {
        sel.addEventListener("change", async () => {
          const idPedido = sel.dataset.id;
          const nuevoEstado = sel.value;
          const fila = sel.closest("tr");
          const badge = fila.querySelector(".status-badge");

          try {
            const res = await fetch(`/admin/api/pedidos/${idPedido}/estado`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ estado: nuevoEstado })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              alert(data.error || "No se pudo actualizar el estado");
              return;
            }

            badge.textContent = nuevoEstado;
            badge.className = "status-badge " +
              (nuevoEstado === "pagado"
                ? "status-pagado"
                : nuevoEstado === "cancelado"
                ? "status-cancelado"
                : "status-pendiente");
          } catch (err) {
            console.error(err);
            alert("Error al actualizar el estado del pedido");
          }
        });
      });

    } catch (err) {
      console.error(err);
      const tabla = document.getElementById("tablaPedidosBody");
      tabla.innerHTML = `
        <tr>
          <td colspan="7" style="text-align:center; padding:12px; color:red;">
            Error al cargar pedidos.
          </td>
        </tr>
      `;
    }
  }

  async function cargarDetallePedido(idPedido, pedidoInfo) {
    try {
      const res = await fetch(`/admin/api/pedidos/${idPedido}/detalles`);
      if (!res.ok) throw new Error("Error al obtener detalles");
      const detalles = await res.json();

      // ---- llenar encabezado ----
      detalleIdSpan.textContent       = idPedido;
      detalleClienteSpan.textContent  = pedidoInfo?.cliente  || "-";
      detalleEmailSpan.textContent    = pedidoInfo?.email    || "-";
      detalleTelefonoSpan.textContent = pedidoInfo?.telefono || "-";
      detalleFechaSpan.textContent    = pedidoInfo?.fecha
        ? new Date(pedidoInfo.fecha).toLocaleString()
        : "-";
      detalleEstadoSpan.textContent   = pedidoInfo?.estado   || "-";
      detalleTotalSpan.textContent    = pedidoInfo
        ? "$" + Number(pedidoInfo.total).toFixed(2)
        : "-";

      // ---- llenar tabla de l√≠neas ----
      detalleLineasBody.innerHTML = "";

      if (!detalles.length) {
        detalleLineasBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center; padding:8px; color:#6b7380;">
              Este pedido no tiene productos registrados.
            </td>
          </tr>
        `;
        detalleTotalFooter.textContent = "";
        abrirDetalleOverlay();
        return;
      }

      let totalCalc = 0;

      detalles.forEach(d => {
        const precio   = Number(d.precio)   || 0;
        const subtotal = Number(d.subtotal) || (precio * (d.cantidad || 1));
        totalCalc += subtotal;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.nombre_producto}</td>
          <td>${d.cantidad}</td>
          <td>$${precio.toFixed(2)}</td>
          <td>$${subtotal.toFixed(2)}</td>
        `;
        detalleLineasBody.appendChild(tr);
      });

      detalleTotalFooter.textContent =
        "Total calculado por l√≠neas: $" + totalCalc.toFixed(2);

      abrirDetalleOverlay();

    } catch (err) {
      console.error(err);
      alert("Error al cargar el detalle del pedido");
    }
  }

  // ======================
  // INICIALIZACI√ìN
  // ======================
  (function init() {
    cargarCategorias();  // tambi√©n llena el select de productos
    cargarProductos();
  })();
</script>
</body>
</html>
